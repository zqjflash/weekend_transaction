## 基于NodeJS的serverless架构实践

### 一、背景

通过将BFF构建于serverless之上，将以往数十个平台应用整合到了一个统一入口。通过云函数的方式取代了传统基于NodeJS的BFF层，实现了在一个站点下不同应用以及不同环境的快速切换。从而极大程度的降低了开发成本和运维成本，使机器数量从上百台缩减为十几台，同时有效减少了业务方的学习和理解成本。

本文主要讲述了BFF局限性以及我们对应的serverless解决方案，其中平台核心功能包括：

* 云函数：将BFF层的Node应用代码拆解成独立云函数，支持动态编写、秒级部署，平台提供隔离的沙箱容器进行执行，并自动接入日志和监控系统，使开发者可实时掌握函数的运行状况；

* 应用：将各平台的前端代码打包部署，入口路由进行统一注册，我们将这些平台称为应用。这些应用将直接支持各环境切换及多套预发环境解决方案；

* SDK：框架将中间件封装为BaaS SDK供应用直接调用，提供一套统一的API抹平了Web和Node的差异；

* CLI：提供命令行工具便于开发者可脱离web管理平台，而直接快速进行开发、调试和发布。

### 二、BFF的局限

从传统大型机到服务器集群，从虚拟技术到容器化，我们正在走向那些更加轻量、更俱灵活性的解决方案。

在行业“大中台，小前台”的大背景下，也逐渐从巨石应用拆分成更为灵活的微服务，以便以更小的粒度服务于更多的需求方。

而前端也在以往前后端分离的基础上，更进一步的演变为了BFF架构。根据最终端上的需求，通过BFF层将各个微服务进行聚合和裁剪后返回。根据“谁受益谁负责”原则，该BFF层通常由前端使用NodeJS维护。

![典型的BFF架构](/asserts/BFF-struct.png)

然而，作为横向支撑的前端团队，我们在实施BFF架构之后，却发现它可能并没有想象的那么美好。截止到目前，已经形成20几个平台，对于大量平台的存在，对开发人员的维护和业务方的理解，都成为了一种负担。

* 首先，每个平台都有一个对应的Node层来作为BFF，我们仍然需要针对每一个平台部署代码、安装依赖的各种软件，关心究竟需要多少台服务器，这极大的增加了我们的运维成本；

* 其次，由于各个平台十分分散，均由独立域名进行访问，不同团队可能并不清楚已经存在一个类似平台从而导致提出相似需求，并且各个平台对于账户、权限、文件上传等中间件都需进行接入，对开发资源造成严重浪费；

* 最后，作为业务方，需要记住大量不同平台域名和对应的功能，也成为了一项挑战。而每个平台还有对应多套环境，也增加了他们的沟通成本和使用成本。

![BFF层横向扩展带来的挑战](/asserts/BFF-struct2.png)

所以，我们核心面临的问题总结起来就是运维成本难降低、重复开发难避免、入口分散难管理。那么有没有一种更轻量的架构，使我们所有人能从上述这些繁琐的工作中解放出来？

我们想到了serverless，它让NoOps成为可能，实现零配置发布业务代码，这能极大降低运维成本。但传统的serverless仍然只能解决一个点的问题，如果我们做的更进一步，将serverless与已有的BFF、FE整合，那是不是有可能同时解决上述问题？基于上述考虑，我们提出了自己的serverless架构。

### 三、serverless

### 四、BFF in serverless

#### 4.1 云函数

#### 4.2 开发者工作台（应用）

#### 4.3 在线环境切换

#### 4.4 多套预发环境管理

#### 4.5 BaaS SDK

#### 4.6 CLI工具

### 五、后续规划

### 六、结尾